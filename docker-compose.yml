version: "3.9"

services:

  # ── Elasticsearch ──────────────────────────────────────────────────────────
  elasticsearch:
    image: elasticsearch:8.14.0
    container_name: recruiting_es
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # ── API (FastAPI) ──────────────────────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: recruiting_api
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
    environment:
      - ES_HOST=http://elasticsearch:9200
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_PARSE_MODEL=${OPENAI_PARSE_MODEL:-gpt-4o-mini}
      - EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
      - DATA_DIR=/app/data
      - RESUMES_DIR=/app/data/resumes
      - LOG_LEVEL=INFO
      - BM25_CANDIDATES=${BM25_CANDIDATES:-20}
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ── Streamlit frontend ─────────────────────────────────────────────────────
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: recruiting_frontend
    restart: unless-stopped
    ports:
      - "8501:8501"
    depends_on:
      api:
        condition: service_healthy

volumes:
  es_data:
