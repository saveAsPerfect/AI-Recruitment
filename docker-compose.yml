services:

  # ── Elasticsearch ──────────────────────────────────────────────────────────
  elasticsearch:
    image: elasticsearch:8.14.0
    container_name: recruiting_es
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9200/_cluster/health" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # ── API (FastAPI) ──────────────────────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: recruiting_api
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
    environment:
      - ES_HOST=http://elasticsearch:9200
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_PARSE_MODEL=${OPENAI_PARSE_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
      - DATA_DIR=/app/data
      - RESUMES_DIR=/app/data/resumes
      - IMAP_HOST=${IMAP_HOST:-}
      - IMAP_PORT=${IMAP_PORT:-993}
      - IMAP_USER=${IMAP_USER:-}
      - IMAP_PASSWORD=${IMAP_PASSWORD:-}
      - IMAP_FOLDER=${IMAP_FOLDER:-INBOX}
      - IMAP_USE_SSL=${IMAP_USE_SSL:-true}
      - IMAP_ALLOWED_EXTENSIONS=${IMAP_ALLOWED_EXTENSIONS:-.pdf,.doc,.docx,.txt}
      - IMAP_MAX_ATTACHMENT_BYTES=${IMAP_MAX_ATTACHMENT_BYTES:-10485760}
      - EMAIL_SCHEDULER_ENABLED=${EMAIL_SCHEDULER_ENABLED:-true}
      - EMAIL_SCHEDULER_INTERVAL_MINUTES=${EMAIL_SCHEDULER_INTERVAL_MINUTES:-60}
      - EMAIL_SCHEDULER_STARTUP_DELAY_SECONDS=${EMAIL_SCHEDULER_STARTUP_DELAY_SECONDS:-15}
      - EMAIL_SCHEDULER_MAX_MESSAGES=${EMAIL_SCHEDULER_MAX_MESSAGES:-50}
      - LOG_LEVEL=INFO
      - BM25_CANDIDATES=${BM25_CANDIDATES:-20}
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/v1/health" ]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ── Streamlit frontend ─────────────────────────────────────────────────────
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: recruiting_frontend
    restart: unless-stopped
    ports:
      - "8501:8501"
    environment:
      - API_URL=http://api:8000/api/v1
    depends_on:
      api:
        condition: service_healthy

volumes:
  es_data:
